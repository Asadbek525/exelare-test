<div
  class="tree-node-wrapper"
  cdkDropList
  [cdkDropListData]="{ node: item(), children: getChildren() }"
  [cdkDropListEnterPredicate]="canDrop"
  [cdkDropListSortingDisabled]="true"
  (cdkDropListDropped)="onDrop($event)"
  (cdkDropListEntered)="onDragEnter($event)"
  (cdkDropListExited)="onDragLeave()"
>
  <div
    cdkDrag
    [cdkDragData]="item()"
    [cdkDragDisabled]="!item().draggable"
    (cdkDragStarted)="onDragStarted($event)"
    (cdkDragEnded)="onDragEnded()"
  >
    <div
      class="tree-node-content flex-1 flex items-center justify-between cursor-pointer transition-all rounded-md px-2 hover:bg-gray-100"
      [class.bg-blue-50]="item().link === router.url"
      [class.text-blue-600]="item().link === router.url"
      [class.font-medium]="item().link === router.url"
      [class.cursor-grab]="item().draggable"
      [class.drop-target-hover]="showDropInto()"
      #node
    >
      <button
        class="flex-1 flex items-center gap-2 p-2 overflow-hidden"
        (click)="navigate()"
        [class.text-blue-600]="item().link === router.url"
      >
        <i [class]="item().icon" class="shrink-0"></i>
        <span
          class="truncate"
          #labelSpan
          [pTooltip]="item().label"
          [tooltipDisabled]="!isTextOverflowed(labelSpan)"
          tooltipPosition="top"
        >
          {{ item().label }}
        </span>

        @if (item().children?.length) {
          <p-badge severity="info" size="small" [value]="item().children!.length" />
        }
      </button>
      @if (item().children?.length) {
        <button
          (click)="toggle()"
          class="cursor-pointer transition-all text-gray-400 hover:text-gray-600"
          [class.text-blue-600]="item().link === router.url"
        >
          <i
            class="pi pi-chevron-right text-sm"
            [@rotateIcon]="item().expanded ? 'expanded' : 'collapsed'"
          ></i>
        </button>
      }
    </div>
    <div *cdkDragPlaceholder></div>
    <ng-template cdkDragPreview>
      <div class="cdk-drag-preview bg-white rounded-lg shadow-lg p-3">
        <div class="flex items-center gap-2">
          <i [class]="item().icon"></i>
          <span class="font-semibold">{{ item().label }}</span>
        </div>
      </div>
    </ng-template>
  </div>
</div>
<p-contextMenu
  #contextMenu
  appendTo="body"
  [target]="node"
  [model]="contextMenuItems()"
  (onShow)="onContextMenuShow()"
  (onHide)="onContextMenuHide()"
/>
<app-create-sublist-dialog [(visible)]="showCreateDialog" (created)="onSublistCreated($event)" />
<app-rename-subfolder-dialog
  [(visible)]="showRenameDialog"
  [currentLabel]="item().label"
  [currentIcon]="item().icon"
  (renamed)="onRenamed($event)"
/>
@if (item().children?.length && item().expanded) {
  <div class="ml-4 my-2 flex flex-col gap-2" [@expandCollapse]="'expanded'">
    @for (child of item().children; track child.id) {
      <app-tree-node [item]="child"></app-tree-node>
    }
  </div>
}
