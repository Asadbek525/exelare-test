<div
  class="tree-node-wrapper"
  cdkDropList
  [cdkDropListData]="{ node: item(), children: getChildren() }"
  [cdkDropListEnterPredicate]="canDrop"
  [cdkDropListSortingDisabled]="true"
  (cdkDropListDropped)="onDrop($event)"
  (cdkDropListEntered)="onDragEnter($event)"
  (cdkDropListExited)="onDragLeave()"
>
  <div
    cdkDrag
    [cdkDragData]="item()"
    [cdkDragDisabled]="!item().draggable"
    (cdkDragStarted)="onDragStarted($event)"
    (cdkDragEnded)="onDragEnded()"
  >
    <div
      class="tree-node-content group flex-1 flex items-center justify-between cursor-pointer transition-all rounded-md px-2 hover:bg-gray-100"
      [class.bg-blue-50]="item().link === router.url"
      [class.text-blue-600]="item().link === router.url"
      [class.font-medium]="item().link === router.url"
      [class.cursor-grab]="item().draggable"
      [class.drop-target-hover]="showDropInto()"
    >
      <button
        class="flex-1 flex items-center gap-2 p-2 overflow-hidden"
        [class.justify-center]="collapsed()"
        (click)="navigate()"
        [class.text-blue-600]="item().link === router.url"
      >
        <i
          [class]="item().icon"
          class="shrink-0"
          [pTooltip]="item().label"
          [tooltipDisabled]="!collapsed()"
          tooltipPosition="right"
        ></i>
        @if (!collapsed()) {
          <span
            class="truncate"
            #labelSpan
            [pTooltip]="item().label"
            [tooltipDisabled]="!isTextOverflowed(labelSpan)"
            tooltipPosition="top"
          >
            {{ item().label }}
          </span>
        }

        <!--        @if (item().children?.length) {-->
        <!--          <p-badge severity="info" size="small" [value]="item().children!.length" />-->
        <!--        }-->
      </button>
      <div class="flex items-center gap-1">
        @if (menuItems().length && !collapsed()) {
          <button
            type="button"
            class="opacity-0 group-hover:opacity-100 focus:opacity-100 cursor-pointer transition-opacity p-1 rounded hover:bg-gray-200 text-gray-400 hover:text-gray-600"
            [class.text-blue-600]="item().link === router.url"
            (click)="actionMenu.toggle($event)"
            aria-label="Actions"
            aria-haspopup="true"
          >
            <i class="pi pi-ellipsis-v text-sm"></i>
          </button>
          <p-menu
            #actionMenu
            [model]="menuItems()"
            [popup]="true"
            appendTo="body"
            (onShow)="onMenuShow()"
            (onHide)="onMenuHide()"
          />
        }
        @if (item().children?.length && !collapsed()) {
          <button
            (click)="toggle()"
            class="cursor-pointer transition-all p-1 text-gray-400 hover:text-gray-600"
            [class.text-blue-600]="item().link === router.url"
          >
            <i
              class="pi pi-chevron-right text-sm"
              [@rotateIcon]="item().expanded ? 'expanded' : 'collapsed'"
            ></i>
          </button>
        }
      </div>
    </div>
    <div *cdkDragPlaceholder></div>
    <ng-template cdkDragPreview>
      <div class="cdk-drag-preview bg-white rounded-lg shadow-lg p-3">
        <div class="flex items-center gap-2">
          <i [class]="item().icon"></i>
          <span class="font-semibold">{{ item().label }}</span>
        </div>
      </div>
    </ng-template>
  </div>
</div>
<app-create-sublist-dialog
  [visible]="showCreateDialog()"
  (visibleChange)="updateDialogVisibility($event, 'create')"
  (created)="onSublistCreated($event)"
/>
<app-rename-subfolder-dialog
  [visible]="showRenameDialog()"
  (visibleChange)="updateDialogVisibility($event, 'rename')"
  [currentLabel]="item().label"
  [currentIcon]="item().icon"
  (renamed)="onRenamed($event)"
/>
@if (item().children?.length && item().expanded && !collapsed()) {
  <div class="ml-4 my-2 flex flex-col gap-2" [@expandCollapse]="'expanded'">
    @for (child of item().children; track child.id) {
      <app-tree-node [item]="child"></app-tree-node>
    }
  </div>
}
